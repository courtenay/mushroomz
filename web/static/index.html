<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mushroom Lighting Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        @keyframes flash-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .flashing { animation: flash-pulse 0.3s ease-in-out infinite; }
        .fixture-light {
            transition: background-color 0.05s ease-out, box-shadow 0.05s ease-out;
        }
        .mushroom-visual {
            background: radial-gradient(ellipse at 50% 30%, rgba(60,60,60,0.8) 0%, rgba(30,30,30,0.9) 100%);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="app()" x-init="init()" class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-purple-400">Mushroom Lighting</h1>
                <template x-if="selectedMushroom !== null">
                    <button @click="selectedMushroom = null" class="text-gray-400 hover:text-white text-sm">
                        &larr; Back to list
                    </button>
                </template>
            </div>
            <div class="flex gap-3">
                <button @click="toggleBlackout()"
                    :class="status.blackout ? 'bg-red-600' : 'bg-gray-700'"
                    class="px-4 py-2 rounded-lg font-medium transition-colors">
                    <span x-text="status.blackout ? 'BLACKOUT ON' : 'Blackout'"></span>
                </button>
                <button @click="saveConfig()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    Save Config
                </button>
            </div>
        </div>

        <!-- Tabs (hidden when viewing mushroom detail) -->
        <div x-show="selectedMushroom === null" class="flex border-b border-gray-700 mb-6">
            <template x-for="tab in ['Dashboard', 'Mushrooms', 'Scenes', 'Network']">
                <button @click="currentTab = tab"
                    :class="currentTab === tab ? 'border-purple-500 text-purple-400' : 'border-transparent text-gray-400 hover:text-gray-200'"
                    class="px-4 py-2 border-b-2 font-medium transition-colors"
                    x-text="tab">
                </button>
            </template>
        </div>

        <!-- Mushroom Detail View -->
        <div x-show="selectedMushroom !== null" x-cloak>
            <template x-if="selectedMushroom !== null">
                <div class="space-y-6">
                    <!-- Mushroom Header -->
                    <div class="bg-gray-800 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <input type="text" x-model="mushrooms[selectedMushroom].name"
                                @change="updateMushroom(selectedMushroom)"
                                class="text-2xl font-bold bg-transparent border-b border-gray-600 focus:border-purple-500 outline-none">
                            <div class="flex gap-2">
                                <button @click="flashAllFixtures(selectedMushroom)"
                                    class="bg-yellow-500 hover:bg-yellow-400 text-black px-4 py-2 rounded-lg font-medium transition-colors">
                                    Flash All
                                </button>
                                <span class="px-3 py-2 rounded-lg text-sm"
                                    :class="getSceneColor(mushrooms[selectedMushroom]?.scene)"
                                    x-text="mushrooms[selectedMushroom]?.scene">
                                </span>
                            </div>
                        </div>

                        <!-- Scene Selection -->
                        <div class="flex gap-2 flex-wrap">
                            <template x-for="scene in scenes" :key="scene.id">
                                <button @click="setScene(selectedMushroom, scene.id)"
                                    :class="mushrooms[selectedMushroom]?.scene === scene.name ? 'bg-purple-600' : 'bg-gray-700 hover:bg-gray-600'"
                                    class="px-4 py-2 rounded-lg transition-colors"
                                    x-text="scene.name">
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Fixtures List -->
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Fixtures</h3>
                        <p class="text-sm text-gray-400 mb-4">
                            Use the flash button to identify which physical light corresponds to each fixture.
                        </p>

                        <div class="space-y-3">
                            <template x-for="(fixture, fIdx) in mushrooms[selectedMushroom]?.fixtures || []" :key="fIdx">
                                <div class="bg-gray-700 rounded-lg p-4">
                                    <div class="flex items-center gap-4">
                                        <!-- Flash Button -->
                                        <button @click="flashFixture(selectedMushroom, fIdx)"
                                            :class="flashingFixtures[`${selectedMushroom}-${fIdx}`] ? 'flashing bg-yellow-400' : 'bg-yellow-500 hover:bg-yellow-400'"
                                            class="text-black px-3 py-2 rounded-lg font-bold text-sm transition-colors shrink-0">
                                            FLASH
                                        </button>

                                        <!-- Fixture Details -->
                                        <div class="flex-1 grid grid-cols-1 md:grid-cols-4 gap-3">
                                            <div>
                                                <label class="text-xs text-gray-400">Name</label>
                                                <input type="text" x-model="fixture.name"
                                                    @change="updateMushroom(selectedMushroom)"
                                                    class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-400">DMX Address</label>
                                                <input type="number" x-model.number="fixture.address"
                                                    @change="updateMushroom(selectedMushroom)"
                                                    class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm"
                                                    min="1" max="512">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-400">Type</label>
                                                <select x-model.number="fixture.channels"
                                                    @change="updateMushroom(selectedMushroom)"
                                                    class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
                                                    <option value="3">RGB (3ch)</option>
                                                    <option value="4">RGBW (4ch)</option>
                                                </select>
                                            </div>
                                            <div class="flex items-end">
                                                <button @click="removeFixture(selectedMushroom, fIdx)"
                                                    class="text-red-400 hover:text-red-300 text-sm px-3 py-2">
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <button @click="addFixture(selectedMushroom)"
                            class="mt-4 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            + Add Fixture
                        </button>
                    </div>

                    <!-- Discovery Tool -->
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">DMX Discovery</h3>
                        <p class="text-sm text-gray-400 mb-4">
                            Flash any DMX address to find unmapped fixtures.
                        </p>
                        <div class="flex items-end gap-4">
                            <div>
                                <label class="text-xs text-gray-400">DMX Address</label>
                                <input type="number" x-model.number="discoveryAddress"
                                    class="w-24 bg-gray-700 border border-gray-600 rounded px-3 py-2"
                                    min="1" max="512">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Channels</label>
                                <select x-model.number="discoveryChannels"
                                    class="bg-gray-700 border border-gray-600 rounded px-3 py-2">
                                    <option value="3">RGB (3)</option>
                                    <option value="4">RGBW (4)</option>
                                </select>
                            </div>
                            <button @click="flashAddress()"
                                class="bg-yellow-500 hover:bg-yellow-400 text-black px-4 py-2 rounded-lg font-medium transition-colors">
                                Flash Address
                            </button>
                            <button @click="addDiscoveredFixture()"
                                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium transition-colors">
                                Add as Fixture
                            </button>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-red-900">
                        <h3 class="text-lg font-semibold mb-4 text-red-400">Danger Zone</h3>
                        <button @click="deleteMushroom(selectedMushroom)"
                            class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            Delete This Mushroom
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Dashboard Tab -->
        <div x-show="currentTab === 'Dashboard' && selectedMushroom === null" x-cloak>
            <!-- Live Visualizer -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <template x-for="mushroom in liveState.mushrooms" :key="mushroom.id">
                    <div class="mushroom-visual rounded-2xl p-5 cursor-pointer hover:ring-2 hover:ring-purple-500 transition-all"
                        :class="mushroom.selected ? 'ring-2 ring-purple-500' : ''"
                        @click="selectedMushroom = mushroom.id">
                        <!-- Mushroom name and scene -->
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-lg" x-text="mushroom.name"></h3>
                            <span class="text-xs px-2 py-1 rounded-full"
                                :class="getSceneColor(mushroom.scene)"
                                x-text="mushroom.scene">
                            </span>
                        </div>

                        <!-- Fixture visualizer -->
                        <div class="flex flex-wrap justify-center gap-3 mb-4 min-h-[80px] items-center">
                            <template x-for="(fixture, fIdx) in mushroom.fixtures" :key="fIdx">
                                <div class="text-center">
                                    <div class="fixture-light w-14 h-14 rounded-full border-2 border-gray-600 mx-auto"
                                        :style="`background-color: rgb(${fixture.r}, ${fixture.g}, ${fixture.b}); box-shadow: 0 0 ${Math.max(fixture.r, fixture.g, fixture.b) / 8}px ${Math.max(fixture.r, fixture.g, fixture.b) / 4}px rgb(${fixture.r}, ${fixture.g}, ${fixture.b})`"
                                        :title="fixture.name + ' (DMX ' + fixture.address + ')'">
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1 truncate max-w-[60px]" x-text="fixture.name.split(' ').pop()"></div>
                                </div>
                            </template>
                            <template x-if="mushroom.fixtures.length === 0">
                                <div class="text-gray-500 text-sm">No fixtures</div>
                            </template>
                        </div>

                        <!-- Scene buttons -->
                        <div class="grid grid-cols-2 gap-2" @click.stop>
                            <template x-for="scene in scenes" :key="scene.id">
                                <button @click="setScene(mushroom.id, scene.id)"
                                    :class="mushroom.scene === scene.name ? 'bg-purple-600' : 'bg-gray-700/50 hover:bg-gray-600'"
                                    class="text-xs py-2 px-2 rounded transition-colors"
                                    x-text="scene.name">
                                </button>
                            </template>
                        </div>
                        <div class="mt-3 text-xs text-purple-400 text-center">Click to configure &rarr;</div>
                    </div>
                </template>
            </div>

            <!-- Controller Panel -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold flex items-center gap-2">
                        <span>ðŸŽ®</span>
                        <span>Controller</span>
                        <span class="text-xs px-2 py-0.5 rounded-full"
                            :class="liveState.controller?.connected ? 'bg-green-500/20 text-green-400' : 'bg-gray-600 text-gray-400'"
                            x-text="liveState.controller?.connected ? (liveState.controller.type || 'Connected') : 'Disconnected'"></span>
                        <template x-if="liveState.launchpad_connected">
                            <span class="text-xs px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-400">Launchpad</span>
                        </template>
                    </h3>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Selected:</span>
                        <span class="text-sm font-semibold text-purple-400"
                            x-text="liveState.selected_mushrooms?.length === liveState.mushrooms.length ? 'All' : liveState.mushrooms.filter(m => m.selected).map(m => m.name).join(', ') || 'None'"></span>
                    </div>
                </div>

                <!-- Live Stick Display (when backend controller connected) -->
                <div x-show="liveState.controller?.connected" class="mb-4 flex justify-center gap-8">
                    <!-- Left Stick -->
                    <div class="text-center">
                        <div class="text-xs text-gray-400 mb-1">Left Stick</div>
                        <div class="relative w-16 h-16 bg-gray-700 rounded-full border-2 border-gray-600">
                            <div class="absolute w-4 h-4 bg-purple-500 rounded-full transform -translate-x-1/2 -translate-y-1/2 transition-all duration-75"
                                :style="`left: ${50 + (liveState.controller?.axes?.[0] || 0) * 40}%; top: ${50 + (liveState.controller?.axes?.[1] || 0) * 40}%`">
                            </div>
                        </div>
                    </div>
                    <!-- Right Stick -->
                    <div class="text-center">
                        <div class="text-xs text-gray-400 mb-1">Right Stick</div>
                        <div class="relative w-16 h-16 bg-gray-700 rounded-full border-2 border-gray-600">
                            <div class="absolute w-4 h-4 bg-blue-500 rounded-full transform -translate-x-1/2 -translate-y-1/2 transition-all duration-75"
                                :style="`left: ${50 + (liveState.controller?.axes?.[2] || 0) * 40}%; top: ${50 + (liveState.controller?.axes?.[3] || 0) * 40}%`">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PS4 Button Layout -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Left side: D-pad for selection -->
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-xs text-gray-400 mb-3 text-center">Mushroom Selection</div>
                        <div class="grid grid-cols-3 gap-1 max-w-[140px] mx-auto">
                            <div></div>
                            <button @click="sendDpad(0, 1)"
                                class="bg-gray-600 hover:bg-gray-500 rounded p-2 text-xs text-center transition-colors"
                                :class="liveState.selected_mushrooms?.length === liveState.mushrooms.length ? 'ring-2 ring-purple-500' : ''">
                                â–²<br><span class="text-[10px] text-gray-400">All</span>
                            </button>
                            <div></div>
                            <button @click="sendDpad(-1, 0)"
                                class="bg-gray-600 hover:bg-gray-500 rounded p-2 text-xs text-center transition-colors"
                                :class="liveState.selected_mushrooms?.includes(0) && liveState.selected_mushrooms?.length === 1 ? 'ring-2 ring-purple-500' : ''">
                                â—€<br><span class="text-[10px] text-gray-400">M1</span>
                            </button>
                            <button @click="sendDpad(0, -1)"
                                class="bg-gray-600 hover:bg-gray-500 rounded p-2 text-xs text-center transition-colors"
                                :class="liveState.selected_mushrooms?.includes(1) && liveState.selected_mushrooms?.length === 1 ? 'ring-2 ring-purple-500' : ''">
                                â–¼<br><span class="text-[10px] text-gray-400">M2</span>
                            </button>
                            <button @click="sendDpad(1, 0)"
                                class="bg-gray-600 hover:bg-gray-500 rounded p-2 text-xs text-center transition-colors"
                                :class="liveState.selected_mushrooms?.includes(2) && liveState.selected_mushrooms?.length === 1 ? 'ring-2 ring-purple-500' : ''">
                                â–¶<br><span class="text-[10px] text-gray-400">M3</span>
                            </button>
                            <div></div>
                        </div>
                    </div>

                    <!-- Right side: Face buttons for scenes -->
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="text-xs text-gray-400 mb-3 text-center">Scene Selection</div>
                        <div class="grid grid-cols-3 gap-1 max-w-[140px] mx-auto">
                            <div></div>
                            <button @click="sendButton(3, true)"
                                class="bg-pink-600/50 hover:bg-pink-500/50 rounded p-2 text-xs text-center transition-colors">
                                â–³<br><span class="text-[10px]">Pastel</span>
                            </button>
                            <div></div>
                            <button @click="sendButton(2, true)"
                                class="bg-green-600/50 hover:bg-green-500/50 rounded p-2 text-xs text-center transition-colors">
                                â–¡<br><span class="text-[10px]">Bio</span>
                            </button>
                            <button @click="sendButton(0, true)"
                                class="bg-blue-600/50 hover:bg-blue-500/50 rounded p-2 text-xs text-center transition-colors">
                                âœ•<br><span class="text-[10px]">Manual</span>
                            </button>
                            <button @click="sendButton(1, true)"
                                class="bg-purple-600/50 hover:bg-purple-500/50 rounded p-2 text-xs text-center transition-colors">
                                â—‹<br><span class="text-[10px]">Audio</span>
                            </button>
                            <div></div>
                        </div>
                    </div>
                </div>

                <!-- Analog sticks (when in Manual mode) -->
                <div class="mt-4 grid grid-cols-2 gap-4" x-show="liveState.mushrooms.some(m => m.selected && m.scene === 'Manual')">
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-2 text-center">Left Stick: Hue / Saturation</div>
                        <div class="flex justify-center gap-4">
                            <input type="range" min="-1" max="1" step="0.1" x-model.number="virtualStick.lx"
                                @input="sendAxis(0, virtualStick.lx)"
                                class="w-20 accent-purple-500">
                            <input type="range" min="-1" max="1" step="0.1" x-model.number="virtualStick.ly"
                                @input="sendAxis(1, virtualStick.ly)" orient="vertical"
                                class="h-16 accent-purple-500" style="writing-mode: vertical-lr; direction: rtl;">
                        </div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-2 text-center">Right Stick: Brightness</div>
                        <div class="flex justify-center">
                            <input type="range" min="-1" max="1" step="0.1" x-model.number="virtualStick.ry"
                                @input="sendAxis(3, virtualStick.ry)" orient="vertical"
                                class="h-16 accent-blue-500" style="writing-mode: vertical-lr; direction: rtl;">
                        </div>
                    </div>
                </div>

                <!-- Options button -->
                <div class="mt-4 flex justify-center">
                    <button @click="sendButton(9, true)"
                        class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm transition-colors"
                        :class="liveState.blackout ? 'ring-2 ring-red-500' : ''">
                        OPTIONS: Toggle Blackout
                    </button>
                </div>
            </div>

            <!-- Quick stats -->
            <div class="bg-gray-800 rounded-lg p-4 flex items-center justify-between">
                <div class="flex gap-6">
                    <div>
                        <span class="text-gray-400 text-sm">Mushrooms:</span>
                        <span class="ml-2 font-semibold" x-text="liveState.mushrooms.length"></span>
                    </div>
                    <div>
                        <span class="text-gray-400 text-sm">Total Fixtures:</span>
                        <span class="ml-2 font-semibold" x-text="liveState.mushrooms.reduce((sum, m) => sum + m.fixtures.length, 0)"></span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full" :class="liveState.blackout ? 'bg-red-500' : 'bg-green-500'"></span>
                    <span class="text-sm" x-text="liveState.blackout ? 'Blackout' : 'Live'"></span>
                </div>
            </div>
        </div>

        <!-- Mushrooms Tab -->
        <div x-show="currentTab === 'Mushrooms' && selectedMushroom === null" x-cloak>
            <div class="space-y-4">
                <template x-for="(mushroom, mIdx) in mushrooms" :key="mushroom.id">
                    <div class="bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-750"
                        @click="selectedMushroom = mIdx">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold text-lg" x-text="mushroom.name"></h3>
                                <p class="text-sm text-gray-400">
                                    <span x-text="mushroom.fixtures.length"></span> fixtures
                                </p>
                            </div>
                            <div class="flex items-center gap-4">
                                <button @click.stop="flashAllFixtures(mIdx)"
                                    class="bg-yellow-500 hover:bg-yellow-400 text-black px-3 py-1 rounded text-sm font-medium">
                                    Flash
                                </button>
                                <span class="text-purple-400">&rarr;</span>
                            </div>
                        </div>
                    </div>
                </template>
                <button @click="addMushroom()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    + Add Mushroom
                </button>
            </div>
        </div>

        <!-- Scenes Tab -->
        <div x-show="currentTab === 'Scenes' && selectedMushroom === null" x-cloak>
            <div class="space-y-6">
                <!-- Pastel Fade -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="font-semibold text-xl mb-2 text-pink-400">Pastel Fade</h3>
                    <p class="text-sm text-gray-400 mb-4">Gentle cycling through the color spectrum</p>

                    <!-- Full spectrum preview -->
                    <div class="mb-6">
                        <div class="h-12 rounded-lg" style="background: linear-gradient(to right, hsl(0,70%,70%), hsl(60,70%,70%), hsl(120,70%,70%), hsl(180,70%,70%), hsl(240,70%,70%), hsl(300,70%,70%), hsl(360,70%,70%))"></div>
                        <div class="text-xs text-gray-500 mt-1 text-center">Full color cycle preview (pastel tones)</div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="text-sm text-gray-400">Cycle Duration</label>
                            <div class="flex items-center gap-3 mt-2">
                                <input type="range" x-model.number="sceneParams.pastel_fade.cycle_duration"
                                    @input="updateSceneParams('pastel_fade')"
                                    class="flex-1 accent-pink-500" min="5" max="120" step="1">
                                <span class="text-lg font-mono w-16 text-right" x-text="sceneParams.pastel_fade.cycle_duration + 's'"></span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Fixture Phase Offset</label>
                            <div class="flex items-center gap-3 mt-2">
                                <input type="range" x-model.number="sceneParams.pastel_fade.phase_offset"
                                    @input="updateSceneParams('pastel_fade')"
                                    class="flex-1 accent-pink-500" min="0" max="1" step="0.05">
                                <span class="text-lg font-mono w-16 text-right" x-text="Math.round(sceneParams.pastel_fade.phase_offset * 100) + '%'"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio Pulse -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="font-semibold text-xl mb-2 text-purple-400">Audio Pulse</h3>
                    <p class="text-sm text-gray-400 mb-4">Beat-reactive lighting with customizable base color</p>

                    <!-- Hue picker with preview -->
                    <div class="mb-6">
                        <label class="text-sm text-gray-400">Base Color</label>
                        <div class="mt-2 flex items-center gap-4">
                            <div class="flex-1">
                                <div class="h-8 rounded-lg mb-2" style="background: linear-gradient(to right, hsl(0,80%,50%), hsl(60,80%,50%), hsl(120,80%,50%), hsl(180,80%,50%), hsl(240,80%,50%), hsl(300,80%,50%), hsl(360,80%,50%))"></div>
                                <input type="range" x-model.number="sceneParams.audio_pulse.base_hue"
                                    @input="updateSceneParams('audio_pulse')"
                                    class="w-full accent-purple-500" min="0" max="360" step="5">
                            </div>
                            <div class="w-20 h-20 rounded-xl border-4 border-gray-600 shadow-lg"
                                :style="`background-color: hsl(${sceneParams.audio_pulse.base_hue}, 80%, 50%); box-shadow: 0 0 30px hsla(${sceneParams.audio_pulse.base_hue}, 80%, 50%, 0.5)`">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm text-gray-400">Decay Rate (how quickly pulses fade)</label>
                        <div class="flex items-center gap-3 mt-2">
                            <span class="text-xs text-gray-500">Slow</span>
                            <input type="range" x-model.number="sceneParams.audio_pulse.decay_rate"
                                @input="updateSceneParams('audio_pulse')"
                                class="flex-1 accent-purple-500" min="0.5" max="10" step="0.5">
                            <span class="text-xs text-gray-500">Fast</span>
                            <span class="text-lg font-mono w-12 text-right" x-text="sceneParams.audio_pulse.decay_rate"></span>
                        </div>
                    </div>
                </div>

                <!-- Bio Glow -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="font-semibold text-xl mb-2 text-green-400">Bio Glow</h3>
                    <p class="text-sm text-gray-400 mb-4">Color gradient based on plant resistance readings</p>

                    <!-- Gradient preview -->
                    <div class="mb-6">
                        <div class="flex items-center gap-4 mb-2">
                            <span class="text-xs text-gray-500">Low Resistance</span>
                            <div class="flex-1 h-12 rounded-lg"
                                :style="`background: linear-gradient(to right, ${hsvToRgbCss(sceneParams.bio_glow.low_color)}, ${hsvToRgbCss(sceneParams.bio_glow.high_color)})`">
                            </div>
                            <span class="text-xs text-gray-500">High Resistance</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-8">
                        <!-- Low Color Picker -->
                        <div>
                            <label class="text-sm text-gray-400 mb-3 block">Low Resistance Color</label>
                            <div class="flex items-start gap-4">
                                <div class="w-24 h-24 rounded-xl border-4 border-gray-600 cursor-pointer relative overflow-hidden"
                                    :style="`background-color: ${hsvToRgbCss(sceneParams.bio_glow.low_color)}`"
                                    @click="$refs.lowColorPicker.click()">
                                    <input type="color" x-ref="lowColorPicker" class="absolute inset-0 opacity-0 cursor-pointer"
                                        :value="hsvToHex(sceneParams.bio_glow.low_color)"
                                        @input="sceneParams.bio_glow.low_color = hexToHsv($event.target.value); updateSceneParams('bio_glow')">
                                </div>
                                <div class="flex-1 space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-500">Hue</label>
                                        <input type="range" x-model.number="sceneParams.bio_glow.low_color[0]"
                                            @input="updateSceneParams('bio_glow')"
                                            class="w-full accent-green-500" min="0" max="360">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">Saturation</label>
                                        <input type="range" x-model.number="sceneParams.bio_glow.low_color[1]"
                                            @input="updateSceneParams('bio_glow')"
                                            class="w-full accent-green-500" min="0" max="1" step="0.05">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">Brightness</label>
                                        <input type="range" x-model.number="sceneParams.bio_glow.low_color[2]"
                                            @input="updateSceneParams('bio_glow')"
                                            class="w-full accent-green-500" min="0" max="1" step="0.05">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- High Color Picker -->
                        <div>
                            <label class="text-sm text-gray-400 mb-3 block">High Resistance Color</label>
                            <div class="flex items-start gap-4">
                                <div class="w-24 h-24 rounded-xl border-4 border-gray-600 cursor-pointer relative overflow-hidden"
                                    :style="`background-color: ${hsvToRgbCss(sceneParams.bio_glow.high_color)}`"
                                    @click="$refs.highColorPicker.click()">
                                    <input type="color" x-ref="highColorPicker" class="absolute inset-0 opacity-0 cursor-pointer"
                                        :value="hsvToHex(sceneParams.bio_glow.high_color)"
                                        @input="sceneParams.bio_glow.high_color = hexToHsv($event.target.value); updateSceneParams('bio_glow')">
                                </div>
                                <div class="flex-1 space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-500">Hue</label>
                                        <input type="range" x-model.number="sceneParams.bio_glow.high_color[0]"
                                            @input="updateSceneParams('bio_glow')"
                                            class="w-full accent-yellow-500" min="0" max="360">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">Saturation</label>
                                        <input type="range" x-model.number="sceneParams.bio_glow.high_color[1]"
                                            @input="updateSceneParams('bio_glow')"
                                            class="w-full accent-yellow-500" min="0" max="1" step="0.05">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">Brightness</label>
                                        <input type="range" x-model.number="sceneParams.bio_glow.high_color[2]"
                                            @input="updateSceneParams('bio_glow')"
                                            class="w-full accent-yellow-500" min="0" max="1" step="0.05">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Tab -->
        <div x-show="currentTab === 'Network' && selectedMushroom === null" x-cloak>
            <div class="bg-gray-800 rounded-lg p-4 max-w-lg">
                <h3 class="font-semibold text-lg mb-4">Network Settings</h3>
                <p class="text-sm text-yellow-400 mb-4">Changes require restart to take effect</p>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-400">Art-Net IP Address</label>
                        <input type="text" x-model="network.artnet_ip"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mt-1">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Art-Net Universe</label>
                        <input type="number" x-model.number="network.artnet_universe"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mt-1"
                            min="0" max="32767">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">OSC Port</label>
                        <input type="number" x-model.number="network.osc_port"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mt-1"
                            min="1024" max="65535">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">DMX Refresh Rate (FPS)</label>
                        <input type="number" x-model.number="network.dmx_fps"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mt-1"
                            min="10" max="44">
                    </div>
                    <button @click="updateNetwork()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        Update Network
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast notification -->
        <div x-show="toast.show" x-transition
            class="fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg"
            :class="toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'"
            x-text="toast.message">
        </div>
    </div>

    <script>
        function app() {
            return {
                currentTab: 'Dashboard',
                selectedMushroom: null,
                mushrooms: [],
                scenes: [],
                sceneParams: {
                    pastel_fade: { cycle_duration: 30, phase_offset: 0.25 },
                    audio_pulse: { base_hue: 280, decay_rate: 3.0 },
                    bio_glow: { low_color: [120, 0.6, 0.4], high_color: [60, 0.8, 0.9] },
                    manual: {}
                },
                network: { artnet_ip: '', artnet_universe: 0, osc_port: 8000, dmx_fps: 40 },
                status: { blackout: false, selected_mushrooms: [] },
                toast: { show: false, message: '', type: 'success' },
                flashingFixtures: {},
                discoveryAddress: 1,
                discoveryChannels: 3,
                liveState: { blackout: false, mushrooms: [], selected_mushrooms: [], controller: { connected: false, axes: [0,0,0,0] }, launchpad_connected: false },
                liveInterval: null,
                gamepadConnected: false,
                gamepadInterval: null,
                lastGamepadState: { axes: [], buttons: [] },
                virtualStick: { lx: 0, ly: 0, ry: 0 },

                async init() {
                    await this.loadData();
                    await this.refreshLive();
                    setInterval(() => this.refreshStatus(), 2000);
                    // Fast polling for live visualizer (10 FPS)
                    this.liveInterval = setInterval(() => this.refreshLive(), 100);
                    // Gamepad polling (60 FPS)
                    this.gamepadInterval = setInterval(() => this.pollGamepad(), 16);
                    // Gamepad connection events
                    window.addEventListener('gamepadconnected', (e) => {
                        this.gamepadConnected = true;
                        this.showToast(`Gamepad connected: ${e.gamepad.id}`, 'success');
                    });
                    window.addEventListener('gamepaddisconnected', () => {
                        this.gamepadConnected = false;
                        this.showToast('Gamepad disconnected', 'error');
                    });
                },

                async loadData() {
                    try {
                        const [mushroomRes, sceneRes, configRes, statusRes] = await Promise.all([
                            fetch('/api/mushrooms'),
                            fetch('/api/scenes'),
                            fetch('/api/config'),
                            fetch('/api/status')
                        ]);
                        this.mushrooms = await mushroomRes.json();
                        this.scenes = await sceneRes.json();
                        const config = await configRes.json();
                        this.sceneParams = config.scene_params;
                        this.network = {
                            artnet_ip: config.artnet_ip,
                            artnet_universe: config.artnet_universe,
                            osc_port: config.osc_port,
                            dmx_fps: config.dmx_fps
                        };
                        this.status = await statusRes.json();
                    } catch (e) {
                        this.showToast('Failed to load data', 'error');
                    }
                },

                async refreshStatus() {
                    try {
                        const res = await fetch('/api/status');
                        this.status = await res.json();
                        for (let m of this.mushrooms) {
                            m.scene = this.status.mushroom_scenes[m.id] || 'Unknown';
                        }
                    } catch (e) {}
                },

                async refreshLive() {
                    try {
                        const res = await fetch('/api/live');
                        this.liveState = await res.json();
                    } catch (e) {}
                },

                // Gamepad API polling
                pollGamepad() {
                    const gamepads = navigator.getGamepads();
                    const gp = gamepads[0];
                    if (!gp) {
                        this.gamepadConnected = false;
                        return;
                    }
                    this.gamepadConnected = true;

                    // Check axes (with deadzone)
                    const deadzone = 0.15;
                    for (let i = 0; i < gp.axes.length && i < 4; i++) {
                        let value = gp.axes[i];
                        if (Math.abs(value) < deadzone) value = 0;
                        else value = (value - Math.sign(value) * deadzone) / (1 - deadzone);

                        if (this.lastGamepadState.axes[i] !== value) {
                            this.lastGamepadState.axes[i] = value;
                            this.sendAxis(i, value);
                        }
                    }

                    // Check buttons
                    for (let i = 0; i < gp.buttons.length; i++) {
                        const pressed = gp.buttons[i].pressed;
                        if (this.lastGamepadState.buttons[i] !== pressed) {
                            this.lastGamepadState.buttons[i] = pressed;
                            // D-pad on browser gamepad is usually buttons 12-15
                            if (i >= 12 && i <= 15 && pressed) {
                                const dpadMap = { 12: [0, 1], 13: [0, -1], 14: [-1, 0], 15: [1, 0] };
                                this.sendDpad(...dpadMap[i]);
                            } else {
                                this.sendButton(i, pressed);
                            }
                        }
                    }
                },

                // Send controller input to server
                async sendAxis(axis, value) {
                    try {
                        await fetch('/api/controller/input', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ input_type: 'axis', axis, value })
                        });
                    } catch (e) {}
                },

                async sendButton(button, pressed) {
                    try {
                        await fetch('/api/controller/input', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ input_type: 'button', button, pressed })
                        });
                    } catch (e) {}
                },

                async sendDpad(x, y) {
                    try {
                        await fetch('/api/controller/input', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ input_type: 'dpad', dpad: [x, y] })
                        });
                    } catch (e) {}
                },

                async setScene(mushroomId, sceneId) {
                    try {
                        await fetch(`/api/mushrooms/${mushroomId}/scene`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ scene: sceneId })
                        });
                        await this.refreshStatus();
                        const m = this.mushrooms.find(m => m.id === mushroomId);
                        if (m) m.scene = this.status.mushroom_scenes[mushroomId];
                    } catch (e) {
                        this.showToast('Failed to set scene', 'error');
                    }
                },

                async toggleBlackout() {
                    try {
                        const res = await fetch('/api/blackout', { method: 'POST' });
                        const data = await res.json();
                        this.status.blackout = data.blackout;
                    } catch (e) {
                        this.showToast('Failed to toggle blackout', 'error');
                    }
                },

                async saveConfig() {
                    try {
                        await fetch('/api/config/save', { method: 'POST' });
                        this.showToast('Config saved!', 'success');
                    } catch (e) {
                        this.showToast('Failed to save config', 'error');
                    }
                },

                async updateMushroom(idx) {
                    const m = this.mushrooms[idx];
                    try {
                        await fetch(`/api/mushrooms/${m.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: m.name, fixtures: m.fixtures })
                        });
                    } catch (e) {
                        this.showToast('Failed to update mushroom', 'error');
                    }
                },

                async deleteMushroom(idx) {
                    const m = this.mushrooms[idx];
                    if (!confirm(`Delete ${m.name}? This cannot be undone.`)) return;
                    try {
                        await fetch(`/api/mushrooms/${m.id}`, { method: 'DELETE' });
                        this.selectedMushroom = null;
                        await this.loadData();
                        this.showToast('Mushroom deleted', 'success');
                    } catch (e) {
                        this.showToast('Failed to delete mushroom', 'error');
                    }
                },

                async addMushroom() {
                    const name = `Mushroom ${this.mushrooms.length + 1}`;
                    try {
                        await fetch('/api/mushrooms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name, fixtures: [] })
                        });
                        await this.loadData();
                    } catch (e) {
                        this.showToast('Failed to add mushroom', 'error');
                    }
                },

                addFixture(mIdx) {
                    const m = this.mushrooms[mIdx];
                    const lastAddr = m.fixtures.length > 0
                        ? m.fixtures[m.fixtures.length - 1].address + m.fixtures[m.fixtures.length - 1].channels
                        : 1;
                    m.fixtures.push({ name: `Fixture ${m.fixtures.length + 1}`, address: lastAddr, channels: 3 });
                    this.updateMushroom(mIdx);
                },

                removeFixture(mIdx, fIdx) {
                    if (!confirm('Remove this fixture?')) return;
                    this.mushrooms[mIdx].fixtures.splice(fIdx, 1);
                    this.updateMushroom(mIdx);
                },

                async flashFixture(mIdx, fIdx) {
                    const key = `${mIdx}-${fIdx}`;
                    this.flashingFixtures[key] = true;
                    try {
                        await fetch(`/api/mushrooms/${mIdx}/fixtures/${fIdx}/flash`, { method: 'POST' });
                        this.showToast('Flashing fixture...', 'success');
                    } catch (e) {
                        this.showToast('Failed to flash fixture', 'error');
                    }
                    setTimeout(() => {
                        this.flashingFixtures[key] = false;
                    }, 1000);
                },

                async flashAllFixtures(mIdx) {
                    try {
                        await fetch(`/api/mushrooms/${mIdx}/flash`, { method: 'POST' });
                        this.showToast('Flashing all fixtures...', 'success');
                    } catch (e) {
                        this.showToast('Failed to flash fixtures', 'error');
                    }
                },

                async flashAddress() {
                    try {
                        await fetch('/api/fixtures/flash', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                address: this.discoveryAddress,
                                channels: this.discoveryChannels
                            })
                        });
                        this.showToast(`Flashing address ${this.discoveryAddress}...`, 'success');
                    } catch (e) {
                        this.showToast('Failed to flash address', 'error');
                    }
                },

                addDiscoveredFixture() {
                    if (this.selectedMushroom === null) return;
                    const m = this.mushrooms[this.selectedMushroom];
                    m.fixtures.push({
                        name: `Fixture ${m.fixtures.length + 1}`,
                        address: this.discoveryAddress,
                        channels: this.discoveryChannels
                    });
                    this.updateMushroom(this.selectedMushroom);
                    this.discoveryAddress += this.discoveryChannels;
                    this.showToast('Fixture added!', 'success');
                },

                async updateSceneParams(sceneId) {
                    try {
                        await fetch(`/api/scenes/${sceneId}/params`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.sceneParams[sceneId])
                        });
                    } catch (e) {
                        this.showToast('Failed to update scene params', 'error');
                    }
                },

                async updateNetwork() {
                    try {
                        await fetch('/api/network', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.network)
                        });
                        this.showToast('Network updated (restart required)', 'success');
                    } catch (e) {
                        this.showToast('Failed to update network', 'error');
                    }
                },

                getSceneColor(scene) {
                    const colors = {
                        'Pastel Fade': 'bg-pink-500/20 text-pink-400',
                        'Audio Pulse': 'bg-purple-500/20 text-purple-400',
                        'Bio Glow': 'bg-green-500/20 text-green-400',
                        'Manual': 'bg-blue-500/20 text-blue-400'
                    };
                    return colors[scene] || 'bg-gray-500/20 text-gray-400';
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                },

                // HSV to RGB CSS string
                hsvToRgbCss(hsv) {
                    if (!hsv || hsv.length < 3) return 'rgb(128,128,128)';
                    const [h, s, v] = hsv;
                    const rgb = this.hsvToRgb(h, s, v);
                    return `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
                },

                // HSV to Hex for color picker
                hsvToHex(hsv) {
                    if (!hsv || hsv.length < 3) return '#808080';
                    const [h, s, v] = hsv;
                    const rgb = this.hsvToRgb(h, s, v);
                    return '#' + rgb.map(c => c.toString(16).padStart(2, '0')).join('');
                },

                // Hex to HSV from color picker
                hexToHsv(hex) {
                    const r = parseInt(hex.slice(1, 3), 16) / 255;
                    const g = parseInt(hex.slice(3, 5), 16) / 255;
                    const b = parseInt(hex.slice(5, 7), 16) / 255;

                    const max = Math.max(r, g, b);
                    const min = Math.min(r, g, b);
                    const d = max - min;

                    let h = 0;
                    if (d !== 0) {
                        if (max === r) h = ((g - b) / d + 6) % 6;
                        else if (max === g) h = (b - r) / d + 2;
                        else h = (r - g) / d + 4;
                        h *= 60;
                    }

                    const s = max === 0 ? 0 : d / max;
                    const v = max;

                    return [Math.round(h), Math.round(s * 100) / 100, Math.round(v * 100) / 100];
                },

                // HSV to RGB array
                hsvToRgb(h, s, v) {
                    h = h / 360;
                    let r, g, b;
                    const i = Math.floor(h * 6);
                    const f = h * 6 - i;
                    const p = v * (1 - s);
                    const q = v * (1 - f * s);
                    const t = v * (1 - (1 - f) * s);

                    switch (i % 6) {
                        case 0: r = v; g = t; b = p; break;
                        case 1: r = q; g = v; b = p; break;
                        case 2: r = p; g = v; b = t; break;
                        case 3: r = p; g = q; b = v; break;
                        case 4: r = t; g = p; b = v; break;
                        case 5: r = v; g = p; b = q; break;
                    }

                    return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
                }
            }
        }
    </script>
</body>
</html>
